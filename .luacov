-- Configuration file for LuaCov

local source = os.getenv("PWD") or io.popen("cd"):read() -- working dir: https://programming-idioms.org/idiom/106/get-program-working-directory/3804/lua
print("source = " .. tostring(source))

if not source then
    source = "home/runner/work/NoitaMP/NoitaMP"
end

local function escape_pattern(str)
    local str_sub = string.gsub(str, "%W", "%%%1")
    print(str_sub)
    return str_sub
end

--- I want to have fixed pathes on coveralls.io, without changing the path on coveralls.io manually..
---@param str string
local function fix_paths(str)
    local str_replace = str:gsub(str, "home/runner/work/NoitaMP/NoitaMP", "")
    str_replace = str:gsub(str, "mods/", "")
    print("fixed_path = " .. tostring(str_replace))
    return str_replace
end

return {
    --statsfile = build .. "/luacov.stats.out",
    --reportfile = build .. "/luacov.report.out",
    --include = {
    --    escape_pattern(source) .. "/.+",
    --    -- Relative paths (to source/build dir).
    --    "^[^/].+"
    --},
    -- configuration for luacov-coveralls reporter
    coveralls = {
        pathcorrect = {
            {
                --escape_pattern(source .. "/"),
                --""
                fix_paths(source .. "")
            }
        }
    }
}
